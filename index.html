<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Singapore PSI Data (Live)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; background-color: #fafafa; }
    h1 { color: #333; margin: 0 0 6px; }
    #updatedTime, #dataTimestamp { margin-top: 6px; font-size: 0.95em; color: #666; }
    table { border-collapse: collapse; width: 100%; margin-top: 16px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f4f4f4; }
    tbody tr:hover td { background: #f8f8f8; }
  </style>
</head>
<body>
  <h1>Singapore Real-time PSI Data</h1>
  <p id="dataTimestamp">Loading data timestamp...</p>
  <p id="updatedTime">Loading update time...</p>

  <table id="psiTable">
    <thead>
      <tr>
        <th>Reading Type</th>
        <th>National</th>
        <th>Central</th>
        <th>West</th>
        <th>East</th>
        <th>North</th>
        <th>South</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const API = 'https://api.data.gov.sg/v1/environment/psi';
    // Keep region order consistent with header:
    const REGIONS = ['national','central','west','east','north','south'];

    async function loadPSIData() {
      try {
        const response = await fetch(API, { cache: "no-store" });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();

        if (!data?.items?.length || !data.items[0]?.readings) {
          throw new Error('Unexpected API shape: missing items[0].readings');
        }

        const item = data.items[0];
        const readings = item.readings;
        const timestamp = item.timestamp;
        const updateTime = item.update_timestamp || item.timestamp; // fallback

        const tbody = document.querySelector("#psiTable tbody");
        const updatedTimeEl = document.getElementById("updatedTime");
        const dataTimestampEl = document.getElementById("dataTimestamp");

        // Clear existing rows
        tbody.innerHTML = "";

        // Build rows for each reading type
        Object.entries(readings).forEach(([key, regionVals]) => {
          const tr = document.createElement("tr");

          // First cell: reading name
          const nameTd = document.createElement("td");
          nameTd.textContent = key;
          tr.appendChild(nameTd);

          // Region cells in fixed order
          REGIONS.forEach(r => {
            const td = document.createElement("td");
            const v = regionVals?.[r];
            td.textContent = (v == null || Number.isNaN(v)) ? 'â€”'
                           : (typeof v === 'number' && !Number.isInteger(v)) ? v.toFixed(2)
                           : String(v);
            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        });

        // Friendly times in SG timezone
        const dataTime = timestamp
          ? new Date(timestamp).toLocaleString("en-SG", { timeZone: "Asia/Singapore" })
          : 'â€”';
        const updateDisplayTime = updateTime
          ? new Date(updateTime).toLocaleString("en-SG", { timeZone: "Asia/Singapore" })
          : 'â€”';

        dataTimestampEl.textContent = `ðŸ“… Data recorded at: ${dataTime}`;
        updatedTimeEl.textContent   = `ðŸ”„ Data last updated at: ${updateDisplayTime}`;

      } catch (err) {
        console.error("Error fetching PSI data:", err);
        document.getElementById("updatedTime").textContent =
          `Error fetching data: ${err.message}`;
      }
    }

    // Initial load + auto-refresh every 5 minutes
    loadPSIData();
    setInterval(loadPSIData, 5 * 60 * 1000);
  </script>
</body>
</html>
