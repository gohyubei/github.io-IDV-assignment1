<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Singapore PSI Data (Live)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; background-color: #fafafa; }
    h1 { color: #333; margin: 0 0 6px; }
    #updatedTime, #dataTimestamp { margin-top: 6px; font-size: 0.95em; color: #666; }
    table { border-collapse: collapse; width: 100%; margin-top: 16px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f4f4f4; }
    tbody tr:hover td { background: #f8f8f8; }
  </style>
</head>
<body>
  <h1>Singapore Real-time PSI Data</h1>
  <p id="dataTimestamp">Loading data timestamp...</p>
  <p id="updatedTime">Loading update time...</p>

  <table id="psiTable">
    <thead>
      <tr>
        <th>Metrics</th>
        <th>National</th>
        <th>Central</th>
        <th>West</th>
        <th>East</th>
        <th>North</th>
        <th>South</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const API = 'https://api.data.gov.sg/v1/environment/psi';
    const REGIONS = ['national','central','west','east','north','south'];

    function formatVal(v){
      if (v == null || Number.isNaN(v)) return 'â€”';
      return (typeof v === 'number' && !Number.isInteger(v)) ? v.toFixed(2) : String(v);
    }

    // If 'national' is missing, derive it from the five regions
    function ensureNational(regionVals){
      if (regionVals.national != null) return regionVals;
      const keys = ['central','west','east','north','south'];
      const nums = keys.map(k => regionVals[k]).filter(v => typeof v === 'number');
      if (nums.length === keys.length) {
        const avg = nums.reduce((a,b)=>a+b,0) / nums.length;
        return { ...regionVals, national: avg }; // derived
      }
      return regionVals; // leave as-is if we can't derive
    }

    async function loadPSIData() {
      try {
        const response = await fetch(API, { cache: "no-store" });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();

        const item = data?.items?.[0];
        const readings = item?.readings;
        if (!readings) throw new Error('Unexpected API shape: missing items[0].readings');

        const tbody = document.querySelector("#psiTable tbody");
        const updatedTimeEl = document.getElementById("updatedTime");
        const dataTimestampEl = document.getElementById("dataTimestamp");

        tbody.innerHTML = "";

        Object.entries(readings).forEach(([metric, values]) => {
          const vals = ensureNational(values);
          const tr = document.createElement("tr");

          // Metrics name cell
          const nameTd = document.createElement("td");
          nameTd.textContent = metric;
          tr.appendChild(nameTd);

          // Region cells in fixed header order
          REGIONS.forEach(r => {
            const td = document.createElement("td");
            const v = vals?.[r];
            td.textContent = formatVal(v);
            if (r === 'national' && values.national == null && typeof v === 'number') {
              td.title = 'Derived from regional average';
            }
            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        });

        const dataTime = item.timestamp
          ? new Date(item.timestamp).toLocaleString("en-SG", { timeZone: "Asia/Singapore" })
          : 'â€”';
        const updateDisplayTime = (item.update_timestamp || item.timestamp)
          ? new Date(item.update_timestamp || item.timestamp).toLocaleString("en-SG", { timeZone: "Asia/Singapore" })
          : 'â€”';

        dataTimestampEl.textContent = `ðŸ“… Data recorded at: ${dataTime}`;
        updatedTimeEl.textContent   = `ðŸ”„ Data last updated at: ${updateDisplayTime}`;

      } catch (err) {
        console.error("Error fetching PSI data:", err);
        document.getElementById("updatedTime").textContent =
          `Error fetching data: ${err.message}`;
      }
    }

    loadPSIData();
    setInterval(loadPSIData, 5 * 60 * 1000); // auto-refresh every 5 minutes
  </script>
</body>
</html>
